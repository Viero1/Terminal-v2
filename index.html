<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>MRKT AI Terminal - Real Data</title>
    <meta name="theme-color" content="#0f1420">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    
    <style>
        :root {
            --bg: #0f1420;
            --panel: #151b2b;
            --text: #e6e9ef;
            --muted: #9aa4b2;
            --green: #00c851;
            --red: #ff4444;
            --yellow: #ffaa00;
            --blue: #2396ff;
        }
        
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
            height: 100vh;
        }
        
        .topbar {
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            background: #0b1020;
            border-bottom: 1px solid #1f2a44;
            z-index: 100;
            flex-shrink: 0;
        }
        
        .brand {
            font-weight: 700;
            font-size: 14px;
        }
        
        .status {
            font-size: 11px;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .live-dot {
            color: #ff3b30;
            font-size: 8px;
            animation: pulse 1.4s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        .api-input-bar {
            height: 50px;
            padding: 8px 12px;
            background: #0b1020;
            border-bottom: 1px solid #1f2a44;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 11px;
        }
        
        .api-input-bar input {
            flex: 1;
            background: #151b2b;
            border: 1px solid #273151;
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--text);
            font-size: 11px;
        }
        
        .api-input-bar button {
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 56px - 50px);
            overflow: hidden;
        }
        
        .symbol-bar {
            height: 40px;
            display: flex;
            gap: 8px;
            padding: 6px 10px;
            background: #0b1020;
            border-bottom: 1px solid #1f2a44;
            overflow-x: auto;
            overflow-y: hidden;
            flex-shrink: 0;
        }
        
        .symbol-btn {
            background: #151b2b;
            color: #9aa4b2;
            border: 1px solid #273151;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 11px;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.2s;
            min-width: 60px;
        }
        
        .symbol-btn.active {
            background: var(--blue);
            color: #fff;
            border-color: var(--blue);
        }
        
        .symbol-btn.loading {
            opacity: 0.6;
        }
        
        .chart-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .chart-header {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            background: var(--panel);
            border-bottom: 1px solid #1f2a44;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .tf-switch {
            display: flex;
            gap: 4px;
        }
        
        .tf-switch button {
            background: #11172a;
            color: #cfd6e4;
            border: 1px solid #273151;
            border-radius: 3px;
            padding: 3px 7px;
            font-size: 10px;
            cursor: pointer;
            transition: 0.2s;
        }
        
        .tf-switch button.active {
            border-color: var(--blue);
            color: #fff;
            background: rgba(35, 150, 255, 0.1);
        }
        
        .chart-canvas {
            flex: 1;
            background: var(--panel);
            position: relative;
            overflow: hidden;
            touch-action: none;
        }
        
        #tradingview-chart {
            width: 100%;
            height: 100%;
        }
        
        .bottom-panels {
            height: 35vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            padding: 8px;
            overflow-y: auto;
            border-top: 1px solid #1f2a44;
            flex-shrink: 0;
        }
        
        .panel {
            background: var(--panel);
            border: 1px solid #1f2a44;
            border-radius: 6px;
            padding: 10px;
            font-size: 11px;
            overflow-y: auto;
        }
        
        .panel h3 {
            margin: 0 0 6px;
            font-size: 11px;
            color: #cfd6e4;
        }
        
        .panel-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            font-size: 10px;
        }
        
        .status-msg {
            font-size: 10px;
            color: var(--yellow);
            margin: 4px 0;
        }
        
        .error-msg {
            font-size: 10px;
            color: var(--red);
        }
        
        .success-msg {
            font-size: 10px;
            color: var(--green);
        }
    </style>
</head>
<body>
    <header class="topbar">
        <div class="brand">MRKT AI Terminal - Real Data</div>
        <div class="status">
            <span class="live-dot" id="live-indicator">‚óè</span>
            <span id="status-text">Offline</span>
        </div>
    </header>

    <!-- API Key Input -->
    <div class="api-input-bar">
        <span style="color: var(--muted);">EODHD API Key:</span>
        <input type="password" id="api-key-input" placeholder="Paste API key dari eodhd.com" value="">
        <button onclick="saveApiKey()">Save</button>
        <span id="api-status" style="font-size: 10px;"></span>
    </div>

    <div class="main-container">
        <!-- Symbol selector bar -->
        <div class="symbol-bar" id="symbol-bar"></div>

        <!-- Chart area -->
        <div class="chart-container">
            <div class="chart-header">
                <span id="symbol-name">EURUSD</span>
                <div class="tf-switch" id="tf-switch">
                    <button data-tf="1">1m</button>
                    <button data-tf="5">5m</button>
                    <button data-tf="15">15m</button>
                    <button data-tf="60">1h</button>
                    <button data-tf="240">4h</button>
                    <button data-tf="1440" class="active">Daily</button>
                </div>
            </div>
            <div class="chart-canvas">
                <div id="tradingview-chart"></div>
            </div>
        </div>

        <!-- Bottom analysis panels -->
        <div class="bottom-panels">
            <div class="panel">
                <h3>üìä Market Info</h3>
                <div class="panel-row">
                    <span>Current Price:</span>
                    <span id="current-price" style="font-weight: 600;">--</span>
                </div>
                <div class="panel-row">
                    <span>24h High:</span>
                    <span id="day-high" style="font-weight: 600;">--</span>
                </div>
                <div class="panel-row">
                    <span>24h Low:</span>
                    <span id="day-low" style="font-weight: 600;">--</span>
                </div>
                <div class="panel-row">
                    <span>Change:</span>
                    <span id="change-pct" style="font-weight: 600;">--</span>
                </div>
            </div>

            <div class="panel">
                <h3>üìà Data Status</h3>
                <div id="data-status" class="status-msg">Waiting for API key...</div>
                <div id="last-update" class="panel-row">
                    <span>Last Update:</span>
                    <span>--</span>
                </div>
                <div id="data-source" class="panel-row">
                    <span>Source:</span>
                    <span>EODHD</span>
                </div>
            </div>

            <div class="panel">
                <h3>üí° Instructions</h3>
                <div style="font-size: 10px; line-height: 1.4;">
                    1. Daftar gratis: <strong>eodhd.com</strong><br>
                    2. Copy API Key<br>
                    3. Paste di atas ‚Üí Click Save<br>
                    4. Pilih symbol & timeframe<br>
                    5. Chart loading data real
                </div>
            </div>

            <div class="panel">
                <h3>üîó Supported Symbols</h3>
                <div style="font-size: 9px; line-height: 1.3;">
                    Forex: EURUSD, GBPUSD, USDJPY, AUDUSD<br>
                    Commodities: XAUUSD, XAGUSD<br>
                    Index: US500, NDX<br>
                    Stocks: AAPL, MSFT, GOOGL, TSLA<br>
                    Crypto: BTC, ETH
                </div>
            </div>
        </div>
    </div>

    <script>
        // TradingView Chart
        let chart = null;
        let candleSeries = null;
        
        // EODHD Symbols mapping
        const symbolsMap = {
            'EURUSD': 'EURUSD.FOREX',
            'GBPUSD': 'GBPUSD.FOREX',
            'USDJPY': 'USDJPY.FOREX',
            'AUDUSD': 'AUDUSD.FOREX',
            'XAUUSD': 'XAUUSD.COMMODITY',
            'XAGUSD': 'XAGUSD.COMMODITY',
            'US500': 'INDU.INDX',  // S&P 500
            'AAPL': 'AAPL.US',
            'MSFT': 'MSFT.US',
            'GOOGL': 'GOOGL.US',
            'TSLA': 'TSLA.US',
            'BTC': 'BTC.CC',
            'ETH': 'ETH.CC'
        };

        const displaySymbols = [
            'EURUSD', 'GBPUSD', 'USDJPY', 'AUDUSD',
            'XAUUSD', 'US500',
            'AAPL', 'MSFT', 'GOOGL', 'TSLA',
            'BTC', 'ETH'
        ];

        let currentSymbol = 'EURUSD';
        let currentTimeframe = '1440';
        let apiKey = localStorage.getItem('eodhd-api-key') || '';

        // Initialize Chart
        function initChart() {
            const container = document.getElementById('tradingview-chart');
            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: { color: '#0f1420' },
                    textColor: '#e6e9ef',
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: false,
                    barSpacing: 20,
                },
                grid: {
                    horzLines: { color: 'rgba(255, 255, 255, 0.1)' },
                    vertLines: { color: 'rgba(255, 255, 255, 0.1)' },
                },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#00c851',
                downColor: '#ff4444',
                wickUpColor: '#00c851',
                wickDownColor: '#ff4444',
                borderVisible: true,
            });

            chart.timeScale().fitContent();
            window.addEventListener('resize', () => chart && chart.applyOptions({ width: container.clientWidth, height: container.clientHeight }));
        }

        // Save API Key
        function saveApiKey() {
            apiKey = document.getElementById('api-key-input').value.trim();
            if (!apiKey) {
                document.getElementById('api-status').innerHTML = '<span class="error-msg">‚ùå API key kosong</span>';
                return;
            }
            localStorage.setItem('eodhd-api-key', apiKey);
            document.getElementById('api-status').innerHTML = '<span class="success-msg">‚úì Saved</span>';
            loadChartData();
        }

        // Load Chart Data from EODHD
        async function loadChartData() {
            if (!apiKey) {
                document.getElementById('data-status').innerHTML = '<span class="error-msg">‚ùå API key belum diset</span>';
                return;
            }

            const eodSymbol = symbolsMap[currentSymbol];
            const period = currentTimeframe;
            const url = `https://eodhd.com/api/eod/${eodSymbol}?api_token=${apiKey}&period=${period}&fmt=json`;

            document.getElementById('data-status').innerHTML = '<span class="status-msg">‚è≥ Loading...</span>';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (!data || !Array.isArray(data) || data.length === 0) {
                    throw new Error('No data received');
                }

                // Convert EODHD format ke TradingView format
                const candles = data.map(d => ({
                    time: Math.floor(new Date(d.date).getTime() / 1000),
                    open: d.open,
                    high: d.high,
                    low: d.low,
                    close: d.close,
                    volume: d.volume
                }));

                candleSeries.setData(candles);
                chart.timeScale().fitContent();

                // Update info panel
                const latest = data[data.length - 1];
                document.getElementById('current-price').textContent = latest.close.toFixed(4);
                document.getElementById('day-high').textContent = latest.high.toFixed(4);
                document.getElementById('day-low').textContent = latest.low.toFixed(4);
                
                const change = ((latest.close - data[0].open) / data[0].open * 100).toFixed(2);
                document.getElementById('change-pct').textContent = `${change}%`;
                
                document.getElementById('last-update').innerHTML = `
                    <span>Last Update:</span>
                    <span>${new Date().toLocaleTimeString()}</span>
                `;
                
                document.getElementById('data-status').innerHTML = '<span class="success-msg">‚úì Data loaded from EODHD</span>';
                document.getElementById('status-text').textContent = 'LIVE (EODHD)';
                document.getElementById('live-indicator').style.color = '#00c851';

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('data-status').innerHTML = `<span class="error-msg">‚ùå ${error.message}</span><br>‚ö†Ô∏è Cek API key atau jumlah requests`;
            }
        }

        // Create Symbol Buttons
        function createSymbolButtons() {
            const bar = document.getElementById('symbol-bar');
            displaySymbols.forEach(sym => {
                const btn = document.createElement('button');
                btn.className = `symbol-btn ${sym === currentSymbol ? 'active' : ''}`;
                btn.textContent = sym;
                btn.onclick = () => switchSymbol(sym);
                bar.appendChild(btn);
            });
        }

        // Switch Symbol
        function switchSymbol(sym) {
            currentSymbol = sym;
            document.getElementById('symbol-name').textContent = sym;
            document.querySelectorAll('.symbol-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === sym);
            });
            loadChartData();
        }

        // Timeframe Buttons
        document.querySelectorAll('.tf-switch button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tf-switch button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTimeframe = btn.dataset.tf;
                loadChartData();
            });
        });

        // Load saved API key if exists
        if (apiKey) {
            document.getElementById('api-key-input').value = apiKey;
            document.getElementById('api-status').innerHTML = '<span class="success-msg">‚úì API key loaded</span>';
        }

        // Initialize
        initChart();
        createSymbolButtons();
        
        // Auto-load jika ada API key
        if (apiKey) {
            setTimeout(loadChartData, 500);
        }
    </script>
</body>
</html>
